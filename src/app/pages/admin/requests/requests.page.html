<ion-header>
  <ion-toolbar>
    <ion-title>Solicitudes</ion-title>
    <ion-buttons slot="end">
      <ion-select [(ngModel)]="filtroEstado" (ionChange)="cargarSolicitudes()" interface="popover"
        placeholder="Filtrar">
        <ion-select-option value="TODOS">Todas</ion-select-option>
        <ion-select-option value="PENDIENTE">Pendientes</ion-select-option>
        <ion-select-option value="APROBADO">Aprobadas</ion-select-option>
        <ion-select-option value="RECHAZADO">Rechazadas</ion-select-option>
      </ion-select>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <div *ngIf="solicitudes.length === 0" class="empty-state">
    <ion-icon name="folder-open-outline"></ion-icon>
    <p>No hay solicitudes {{ filtroEstado === 'PENDIENTE' ? 'pendientes' : 'en este momento' }}.</p>
  </div>

  <ion-card *ngFor="let req of solicitudes" class="request-card" [ngClass]="'status-' + req.estado">
    <ion-card-content>

      <div class="header-status">
        <div class="client-info">
          <h2 class="client-name">{{ req.profiles.nombre_completo || 'Cliente Nuevo' }}</h2>
          <div class="date-info">
            <ion-icon name="calendar-outline" style="font-size: 12px;"></ion-icon>
            {{ req.created_at | date:'mediumDate' }}
          </div>
        </div>

        <ion-badge [color]="req.estado === 'aprobado' ? 'success' : req.estado === 'rechazado' ? 'danger' : 'warning'">
          {{ req.estado | uppercase }}
        </ion-badge>
      </div>

      <div class="plan-details">
        <ion-icon name="phone-portrait-outline"></ion-icon>
        <p>Solicita: <span>{{ req.planes_moviles.nombre }}</span></p>
      </div>

      <div class="action-buttons">

        <ion-button class="btn-chat" [routerLink]="['/chat-admin', req.user_id]">
          <ion-icon name="chatbubbles-outline" slot="icon-only"></ion-icon>
        </ion-button>

        <ng-container *ngIf="req.estado === 'pendiente'; else historialActions">
          <ion-button class="btn-reject" fill="outline" (click)="actualizarEstado(req.id, 'rechazado')">
            Rechazar
          </ion-button>

          <ion-button class="btn-approve" expand="block" (click)="actualizarEstado(req.id, 'aprobado')">
            Aprobar
          </ion-button>
        </ng-container>

        <ng-template #historialActions>
          <ion-button fill="clear" disabled class="btn-disabled-status">
            {{ req.estado === 'aprobado' ? 'Aprobado' : 'Rechazado' }}
          </ion-button>
        </ng-template>

      </div>

    </ion-card-content>
  </ion-card>

</ion-content>