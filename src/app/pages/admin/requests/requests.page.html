<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Solicitudes de Contratación</ion-title>
    <ion-buttons slot="end">
      <!-- Filtro rápido por estado (ngModel ya es válido) -->
      <ion-select [(ngModel)]="filtroEstado" (ionChange)="cargarSolicitudes()" interface="popover" placeholder="Filtrar">
        <ion-select-option value="TODOS">Todas</ion-select-option>
        <ion-select-option value="PENDIENTE">Pendientes</ion-select-option>
        <ion-select-option value="APROBADO">Aprobadas</ion-select-option>
        <ion-select-option value="RECHAZADO">Rechazadas</ion-select-option>
      </ion-select>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Mensaje de no hay solicitudes -->
  <div *ngIf="solicitudes.length === 0" class="ion-text-center ion-padding-top">
    <p>No hay solicitudes {{ filtroEstado === 'PENDIENTE' ? 'pendientes' : 'en este momento' }}.</p>
    <ion-icon name="happy-outline" size="large" color="medium"></ion-icon>
  </div>

  <!-- Lista de Solicitudes -->
  <ion-card *ngFor="let req of solicitudes" class="request-card">
    <ion-card-content>
      <div class="header-status">
        <!-- Nombre del Cliente (Obtenido del JOIN profiles) -->
        <h2 class="client-name">{{ req.profiles.nombre_completo || 'Cliente Nuevo' }}</h2>
        
        <!-- Estado con Badge -->
        <ion-badge [color]="req.estado === 'aprobado' ? 'success' : req.estado === 'rechazado' ? 'danger' : 'warning'">
          {{ req.estado.toUpperCase() }}
        </ion-badge>
      </div>

      <!-- Información del Plan y Fecha -->
      <p class="plan-info">Plan: {{ req.planes_moviles.nombre }}</p>
      <p class="date-info">{{ req.created_at | date }}</p>

      <div class="action-buttons">
        <!-- Botones de Acción (Solo activos si el estado es 'pendiente') -->
        
        <ion-button 
          color="success" 
          (click)="actualizarEstado(req.id, 'aprobado')"
          [disabled]="req.estado !== 'pendiente'">
          <ion-icon name="checkmark-circle-outline"></ion-icon> Aprobar
        </ion-button>
        
        <ion-button 
          color="danger" 
          (click)="actualizarEstado(req.id, 'rechazado')"
          [disabled]="req.estado !== 'pendiente'">
          <ion-icon name="close-circle-outline"></ion-icon> Rechazar
        </ion-button>

        <!-- Botón para ir al Chat (routerLink ya es válido y req.user_id existe) -->
        <ion-button 
          color="secondary" 
          [routerLink]="['/chat-admin', req.user_id]">
          <ion-icon name="chatbubbles-outline"></ion-icon>
        </ion-button>
      </div>

    </ion-card-content>
  </ion-card>
</ion-content>